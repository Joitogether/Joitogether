<script setup>
import { ref, onMounted } from 'vue'
// import { useRouter } from 'vue-router'
import { getPostsAPI } from '@/apis/userAPIs'
import { useUserStore } from '@/stores/userStore'
import { getPostsCommentAPI } from '@/apis/userAPIs'
import { getPostsLikeAPI } from '@/apis/userAPIs'
import dayjs from 'dayjs'
import relativeTime from 'dayjs/plugin/relativeTime'

const userStore = useUserStore()
const loading = ref(true)
const errorMessage = ref(null)
const userPostList = ref([])
// const router = useRouter()

dayjs.extend(relativeTime)

function timeSince(date) {
  return dayjs(date).fromNow()
}

const fetchUserPosts = async () => {
  try {
    if (!userStore.user?.uid) {
      console.warn('用戶uid不存在')
      return
    }

    const result = await getPostsAPI(userStore.user.uid)

    if (!result?.data?.length) {
      console.log('該用戶還沒有文章')
      userPostList.value = []
      return
    }

    // 使用並發處理
    const enrichedPosts = await Promise.all(
      result.data.map(async (post) => {
        try {
          // 同時獲取留言和按讚數
          const [commentsResult, likesResult] = await Promise.all([
            getPostsCommentAPI(post.post_id).catch(() => ({ data: [] })),
            getPostsLikeAPI(post.post_id).catch(() => ({ data: [] })),
          ])

          return {
            ...post,
            commentCount: commentsResult.data.length,
            likeCount: likesResult.data.length,
          }
        } catch (postError) {
          console.error(`處理貼文 ${post.post_id} 時出錯:`, postError)
          return {
            ...post,
            commentCount: 0,
            likeCount: 0,
          }
        }
      }),
    )

    // 更新貼文列表
    userPostList.value = enrichedPosts

    console.log('貼文數據:', enrichedPosts)
  } catch (err) {
    console.error('獲取用戶貼文出錯:', err)
    errorMessage.value = err.message || '數據加載錯誤'
    userPostList.value = []
  } finally {
    loading.value = false
  }
}
// const handlePostClick = (postId) => {
//   router.push(`/post/${postId}`)
// }
onMounted(() => {
  fetchUserPosts()
})
</script>

<template>
  <div v-if="userPostList.length > 0">
    <div
      v-for="post in userPostList"
      :key="post.post_id"
      class="one-post-bottom cursor-pointer bg-gray-50 rounded-md mb-3 px-5 py-3 md:px-3 md:py-1"
    >
      <div class="post-bottom-top">
        <div class="post-bottom-left flex flex-col gap-1 md:flex-row md:justify-between md:gap-6">
          <div class="md:w-3/4 md:p-3 md:flex md:flex-col md:justify-between">
            <div class="flex flex-col gap-2">
              <div class="flex justify-between">
                <p class="text-xl font-bold">{{ post.post_title }}</p>
                <p class="text-gray-400 text-sm">{{ timeSince(post.created_at) }}</p>
              </div>

              <div class="flex justify-between">
                <p class="post-content text-[16px] text-slate-600 line-clamp-2">
                  {{ post.post_content }}
                </p>
              </div>
              <div
                v-if="post.post_img"
                class="md:hidden post-bottom-right rounded-md overflow-hidden my-3"
              >
                <img :src="post.post_img" alt="Post Image" class="object-cover w-full h-full" />
              </div>
            </div>

            <div class="post-bottom-bottom flex leading-loose">
              <div class="mr-8">👍🏻 {{ post.likeCount || 0 }} 讚</div>
              <div>💬 {{ post.commentCount || 0 }} 留言</div>
            </div>
          </div>
          <div
            class="hidden md:block post-bottom-right w-1/4 aspect-square rounded-md overflow-hidden my-3"
          >
            <img
              v-if="post.post_img"
              :src="post.post_img"
              alt="Post Image"
              class="object-cover w-full h-full"
            />
            <div v-else class="w-full h-full"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div v-else>用戶還沒有任何貼文</div>
</template>
<style scoped>
/* .blockArea {
  display: -webkit-box;
  -webkit-box-orient: vertical;
  overflow: hidden;
} */
</style>
